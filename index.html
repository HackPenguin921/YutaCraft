<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>スト6風バトルゲーム</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
      font-family: monospace;
    }
    canvas {
      display: none;
      margin: 0 auto;
      background: linear-gradient(#555, #222);
    }
    #ui {
      position: absolute;
      top: 10px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      color: white;
      font-size: 18px;
      display: none;
    }
    .bar {
      width: 300px;
      height: 20px;
      background: red;
      border: 2px solid #fff;
    }
    .bar-inner {
      height: 100%;
      background: lime;
    }
    #startScreen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #111;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    #startScreen h1 {
      font-size: 48px;
      margin-bottom: 30px;
    }
    #startScreen button {
      font-size: 24px;
      margin: 10px;
      padding: 10px 30px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: #4caf50;
      color: white;
    }
    #explanationModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      color: white;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      padding: 20px;
      z-index: 20;
    }
    #explanationModal button {
      margin-top: 20px;
      font-size: 18px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>
<div id="startScreen">
  <h1>スト6風バトルゲーム</h1>
  <button onclick="startGame()">スタート</button>
  <button onclick="showExplanation()">説明</button>
</div>

<div id="explanationModal">
  <div>
    <p><strong>プレイヤー1</strong>：左右 ←→、ジャンプ ↑、攻撃 スペース</p>
    <p>必殺技：→ ↓ → + x</p>
    <p><strong>プレイヤー2</strong>：左右 A・D、ジャンプ W、攻撃 F</p>
    <p>体力が0になったらKO！</p>
    <button onclick="hideExplanation()">閉じる</button>
  </div>
</div>

<div id="ui">
  <div>PLAYER HP
    <div class="bar"><div id="playerHp" class="bar-inner" style="width: 100%"></div></div>
  </div>
  <div>ENEMY HP
    <div class="bar"><div id="enemyHp" class="bar-inner" style="width: 100%"></div></div>
  </div>
</div>
<canvas id="gameCanvas" width="960" height="540"></canvas>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const gravity = 1;
const groundY = 470;

const playerImg = new Image();
playerImg.src = "yuta.png";
const enemyImg = new Image();
enemyImg.src = "zombie.png";

let player = {
  x: 100,
  y: groundY,
  vx: 0,
  vy: 0,
  width: 80,
  height: 130,
  hp: 100,
  facing: 1,
  isAttacking: false,
  jumping: false
};

let enemy = {
  x: 700,
  y: groundY,
  vx: 0,
  vy: 0,
  width: 80,
  height: 130,
  hp: 100,
  facing: -1,
  isAttacking: false,
  jumping: false
};

let keys = {};
let specialMoveBuffer = [];

document.addEventListener("keydown", e => {
  keys[e.key] = true;
  specialMoveBuffer.push(e.key);
  if (specialMoveBuffer.length > 10) specialMoveBuffer.shift();
});

document.addEventListener("keyup", e => {
  keys[e.key] = false;
});

function playSound(type) {
  const sounds = {
    hit: new Audio("https://freesound.org/data/previews/256/256113_3263906-lq.mp3"),
    ko: new Audio("https://freesound.org/data/previews/256/256114_3263906-lq.mp3")
  };
  sounds[type]?.play();
}

function drawCharacter(character, img) {
  ctx.save();
  if (character.facing === -1) {
    ctx.translate(character.x + character.width / 2, 0);
    ctx.scale(-1, 1);
    ctx.translate(-character.x - character.width / 2, 0);
  }
  ctx.drawImage(img, character.x, character.y - character.height, character.width, character.height);
  ctx.restore();
}

function attack(attacker, target) {
  if (!attacker.isAttacking) {
    attacker.isAttacking = true;
    setTimeout(() => attacker.isAttacking = false, 500);
    if (Math.abs(attacker.x - target.x) < 90 && Math.abs(attacker.y - target.y) < 60) {
      target.hp -= 10;
      playSound("hit");
      updateHpBar();
    }
  }
}

function specialMove(attacker, target) {
  if (!attacker.isAttacking && attacker.hp > 0 && target.hp > 0) {
    attacker.isAttacking = true;
    setTimeout(() => attacker.isAttacking = false, 800);
    if (Math.abs(attacker.x - target.x) < 120 && Math.abs(attacker.y - target.y) < 80) {
      target.hp -= 25;
      playSound("hit");
      updateHpBar();
    }
  }
}

function updateHpBar() {
  document.getElementById("playerHp").style.width = Math.max(player.hp, 0) + "%";
  document.getElementById("enemyHp").style.width = Math.max(enemy.hp, 0) + "%";
}

function handleInput() {
  player.vx = 0;
  if (keys["ArrowLeft"]) player.vx = -5;
  if (keys["ArrowRight"]) player.vx = 5;
  if (keys["ArrowUp"] && !player.jumping) {
    player.vy = -18;
    player.jumping = true;
  }
  if (keys[" "]) attack(player, enemy);

  if (specialMoveBuffer.slice(-4).join("") === "ArrowRightArrowDownArrowRightx") {
    specialMove(player, enemy);
    specialMoveBuffer = [];
  }

  enemy.vx = 0;
  if (keys["a"]) enemy.vx = -5;
  if (keys["d"]) enemy.vx = 5;
  if (keys["w"] && !enemy.jumping) {
    enemy.vy = -18;
    enemy.jumping = true;
  }
  if (keys["f"]) attack(enemy, player);
}

function applyPhysics(character) {
  character.x += character.vx;
  character.y += character.vy;
  character.vy += gravity;
  if (character.y >= groundY) {
    character.y = groundY;
    character.vy = 0;
    character.jumping = false;
  }
}

function update() {
  handleInput();
  applyPhysics(player);
  applyPhysics(enemy);
  player.facing = player.x < enemy.x ? 1 : -1;
  enemy.facing = enemy.x < player.x ? 1 : -1;

  if (player.hp <= 0 || enemy.hp <= 0) {
    playSound("ko");
    let winner = player.hp > 0 ? "PLAYER" : "ENEMY";
    alert(winner + " WINS!");
    location.reload();
  }
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawCharacter(player, playerImg);
  drawCharacter(enemy, enemyImg);
}

function gameLoop() {
  update();
  render();
  requestAnimationFrame(gameLoop);
}

function startGame() {
  document.getElementById("startScreen").style.display = "none";
  document.getElementById("ui").style.display = "flex";
  canvas.style.display = "block";
  gameLoop();
}

function showExplanation() {
  document.getElementById("explanationModal").style.display = "flex";
}

function hideExplanation() {
  document.getElementById("explanationModal").style.display = "none";
}
</script>
</body>
</html>
