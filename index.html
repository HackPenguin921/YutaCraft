<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>スト6風バトルゲーム</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
      font-family: monospace;
    }
    canvas {
      display: none;
      margin: 0 auto;
      background: linear-gradient(#555, #222);
    }
    #ui {
      position: absolute;
      top: 10px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      color: white;
      font-size: 18px;
      display: none;
    }
    .bar {
      width: 300px;
      height: 20px;
      background: red;
      border: 2px solid #fff;
    }
    .bar-inner {
      height: 100%;
      background: lime;
    }
    #startScreen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #111;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    #startScreen h1 {
      font-size: 48px;
      margin-bottom: 30px;
    }
    #startScreen button {
      font-size: 24px;
      margin: 10px;
      padding: 10px 30px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: #4caf50;
      color: white;
    }
    #explanationModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      color: white;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      padding: 20px;
      z-index: 20;
    }
    #explanationModal button {
      margin-top: 20px;
      font-size: 18px;
      padding: 10px 20px;
    }
    #winMessage {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 48px;
      z-index: 50;
      flex-direction: column;
    }
    #winMessage button {
      margin-top: 20px;
      font-size: 20px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>
<div id="startScreen">
  <h1>スト6風バトルゲーム</h1>
  <button onclick="startGame()">スタート</button>
  <button onclick="showExplanation()">説明</button>
</div>

<div id="explanationModal">
  <div>
    <p><strong>プレイヤー</strong>：左右 ←→、ジャンプ ↑、攻撃 スペース、必殺技 X or M</p>
    <p><strong>CPU</strong>が自動で攻撃してきます！</p>
    <button onclick="hideExplanation()">閉じる</button>
  </div>
</div>

<div id="winMessage">
  <div id="winnerText"></div>
  <button onclick="location.reload()">もう一度</button>
</div>

<div id="ui">
  <div>PLAYER HP
    <div class="bar"><div id="playerHp" class="bar-inner" style="width: 100%"></div></div>
  </div>
  <div>CPU HP
    <div class="bar"><div id="enemyHp" class="bar-inner" style="width: 100%"></div></div>
  </div>
</div>
<canvas id="gameCanvas" width="960" height="540"></canvas>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const gravity = 1;
const groundY = 470;

const playerImg = new Image();
playerImg.src = "yuta.png";
const enemyImg = new Image();
enemyImg.src = "zombie.png";

let player = {
  x: 100, y: groundY, vx: 0, vy: 0, width: 80, height: 130,
  hp: 100, facing: 1, isAttacking: false, jumping: false
};
let enemy = {
  x: 700, y: groundY, vx: 0, vy: 0, width: 80, height: 130,
  hp: 100, facing: -1, isAttacking: false, jumping: false
};

let keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

function playSound(type) {
  const sounds = {
    hit: new Audio("https://freesound.org/data/previews/256/256113_3263906-lq.mp3"),
    ko: new Audio("https://freesound.org/data/previews/256/256114_3263906-lq.mp3")
  };
  sounds[type]?.play();
}

function drawCharacter(c, img) {
  ctx.save();
  if (c.facing === -1) {
    ctx.translate(c.x + c.width / 2, 0);
    ctx.scale(-1, 1);
    ctx.translate(-c.x - c.width / 2, 0);
  }
  ctx.drawImage(img, c.x, c.y - c.height, c.width, c.height);
  ctx.restore();
}

function attack(attacker, target, power = 10) {
  if (!attacker.isAttacking) {
    attacker.isAttacking = true;
    setTimeout(() => attacker.isAttacking = false, 500);
    if (Math.abs(attacker.x - target.x) < 90 && Math.abs(attacker.y - target.y) < 60) {
      target.hp -= power;
      playSound("hit");
      updateHpBar();
    }
  }
}

function updateHpBar() {
  document.getElementById("playerHp").style.width = Math.max(player.hp, 0) + "%";
  document.getElementById("enemyHp").style.width = Math.max(enemy.hp, 0) + "%";
}

function handleInput() {
  player.vx = 0;
  if (keys["ArrowLeft"]) player.vx = -5;
  if (keys["ArrowRight"]) player.vx = 5;
  if (keys["ArrowUp"] && !player.jumping) {
    player.vy = -18;
    player.jumping = true;
  }
  if (keys[" "]) attack(player, enemy);
  if (keys["x"] || keys["X"] || keys["m"] || keys["M"]) attack(player, enemy, 25);
}

function applyPhysics(c) {
  c.x += c.vx;
  c.y += c.vy;
  c.vy += gravity;
  if (c.y >= groundY) {
    c.y = groundY;
    c.vy = 0;
    c.jumping = false;
  }
}

function enemyAI() {
  let distance = player.x - enemy.x;
  if (Math.abs(distance) > 100) {
    enemy.vx = distance > 0 ? 2 : -2;
  } else {
    enemy.vx = 0;
    if (Math.random() < 0.02) attack(enemy, player);
    if (Math.random() < 0.01) attack(enemy, player, 25); // 必殺技風
  }
}

function update() {
  handleInput();
  enemyAI();
  applyPhysics(player);
  applyPhysics(enemy);
  player.facing = player.x < enemy.x ? 1 : -1;
  enemy.facing = enemy.x < player.x ? 1 : -1;

  if (player.hp <= 0 || enemy.hp <= 0) {
    playSound("ko");
    document.getElementById("winnerText").textContent = (player.hp > 0 ? "PLAYER" : "CPU") + " WINS!";
    document.getElementById("winMessage").style.display = "flex";
    cancelAnimationFrame(loopId);
  }
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawCharacter(player, playerImg);
  drawCharacter(enemy, enemyImg);
}

let loopId;
function gameLoop() {
  update();
  render();
  loopId = requestAnimationFrame(gameLoop);
}

function startGame() {
  document.getElementById("startScreen").style.display = "none";
  document.getElementById("ui").style.display = "flex";
  canvas.style.display = "block";
  gameLoop();
}
function showExplanation() {
  document.getElementById("explanationModal").style.display = "flex";
}
function hideExplanation() {
  document.getElementById("explanationModal").style.display = "none";
}
</script>
</body>
</html>
